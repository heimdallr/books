# FLibrary

Замена для [MyHomeLib](https://github.com/OleksiyPenkov/MyHomeLib)

#### Преимущества FLibrary перед MyHomeLib
* Скорость работы
  * создание новой коллекции
  * построение навигации
  * построение таблицы/дерева книг
  * извлечение обложки/аннотации
* Улучшеная аннотация
  * есть оглавление, ключевые слова, эпиграф
  * можно посмотреть все картинки книги
  * можно извлечь картинку книги в память/файл
  * можно открыть картинку в системном просмотрщике
* Есть навигация по архивам
* Есть навигация по ключевым словам
* Массовое (>50К) извлечение книг работает
* Автоматически определяет обновление inpx коллекции, умеет добавить новый архив в коллекцию
* Можно добавить в коллекцию неиндексированные книги или архивы с книгами
* Поддержка 7z (а вдруг?)
* Есть русский язык. И плохой английский :)
* Локализованы жанры
* Развивается
#### Недостатки
* Windows 10 x64 минимум. На Win 3, 95, 98, Millenium, Nt3.5, Nt4, 2000, XP, 2003, Vista, 2008, 7, 8, 8.1 (ничего не забыл?:)) не запустится. На Win11 не проверял.
* Только inpx-коллекции, никакого онлайна
* Меньшая интуитивность создания/добавления коллекций
* Нет тулбара
* Меньше настроек
* Очень простой глобальный поиск
* Скорее всего, нет ещё какой-то функциональности MHL, о которой я не знаю
* Отсутствует дизайн
* Есть баги

## Сборка  
### Windows  
Не запустится на винде ниже 10-ки, т.к. исползуется Qt6  
Собиралось только на MS Visual Studio 2022, прочие IDE не тестировались  
Используется C++20  

#### Прописать в переменных окружения:  
SDK_PATH: путь к папке с библиотеками-зависимостями, по умолчанию D:/sdk  
PATH: добавить путь к cmake.exe, версия cmake должна поддерживать вашу версию MSVS.  
PATH: добавить путь к git.exe, необязательно, но полезно, позволит в логах видеть хэш текущего коммита  
PATH: добавить путь к Inno Setup, если нужен инсталлятор.  
PATH: добавить путь к 7z.exe, для сборки портабельной версии.  

#### Зависимости:  
* Qt6  
* xerces-c  
* plog  
* Hypodermic  
* boost, непосредственно не используется, но нужен Hypodermic'у  
* quazip, у него могут быть свои зависимости, например zlib  
* 7za.dll  

Версии и пути относительно SDK_PATH захардкожены в cmake-скриптах, пинки и помидоры принимаются по email  

#### Сконфигурировать:
Запустить батник solution_generate.bat. Возможно, сработают и другие способы, типа cmake-gui, или открыть в студии папку с исходниками.   

#### Собрать:
В результате конфигурирования в папке build будет создан солюшн FLibrary.sln. В нём надо собрать проект FLibrary.  

#### Ещё вариант:
Можно просто запустить батник build.bat. Если окружение настроено правильно, то в папке build/bin/installer будет собран инсталлятор и архив портабельной версии программы.

### Не Windows  
Увы, никак. Кое-где используется WinAPI. И зависимость от 7za.dll  

# fb2cut

Консольное приложение для перепаковки архивов библиотеки  

#### Что делает
1. Извлекает содержимое книг в формате `fb2`, вырезая из них картинки (содержимое узлов `binary`)
1. Картинки складывает отдельно - папка `covers` для обложек, `images` для остальных картинок
1. Ресайзит картинки, если из размеры превышают указанные максимумы
1. Пережимает картинки в `jpeg` с указанным качеством сжатия
1. Для избавленных от картинок `fb2` запускает указанный внешний архиватор с указанными параметрами командной строки к нему. Параметры командной строки по умолчанию заточены под `7z.exe`. ВНИМАНИЕ! Flibrary поддерживает только `zip` и `7z`. Не стоит также делать архивы непрерывными (`solid`), иначе гарантированы тормоза при показе аннотации и извлечении книг.
1. Справку по ключам командной строки можно получить запуском утилиты с ключом `-h`

#### А зачем всё это?
Для уменьшения размер библиотеки в байтах, конечно. Особенно, если не нужны картинки. Или если нужны только обложки. Или если установить разумные ограничения размеров изображений и качество сжатиия. Но даже если оставить картинки в исходном размере, то всё равно будет ощутимый выигрыш от пережатия текстов в `7z` и отдельного хранения изображений без кодирования в `base64`.

#### И что потом делать с перепакованными архивами?
Используем их с `Flibrary` вместо исходных.

#### Что за файлы в папках error?
Там битые картинки, т.е. содержимое узлов `binary`, которое не удалось распарсить в изображение. Действительно, в архивах полно мусора, не являющегося валидными файлами изображений. Что с ним делать - решайте сами. Попадаются вполне годные файлы в неподдерживаемом парсером `Qt` формате, например `riff`. Их можно конвертнуть в `jpeg` каким-нибудь графическим редактором и подложить в соответствующий архив вручную. Или подождать, когда я прикручу к программе ffmpeg (скорее всего никогда).

#### А что так долго-то?
Основное время работы утилита тратит на архивацию внешним архиватором. Увы, алгоритмы сжатия вычислительно затратны. К сожалению, в сжатии алгоритмом PPMD участвуют не более 4-х потоков. Возможно, когда-нибудь я распараллелю запуск N/4 процессов внешнего архиватора (что вряд ли).

#### Пример запуска
`fb2cut.exe D:\fb2.Flibusta.Net\*.zip -q 20 -f D:\repacked --max-width 480 --max-height 480 -a "C:\Program Files\7-Zip\7z.exe"`
