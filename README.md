[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
# FLibrary

<details>
<summary>Скриншоты</summary>
 <img width="1871" alt="image" src="https://github.com/user-attachments/assets/7b5ef1fe-b3e5-4df7-9852-b1ea67241257" />
 <img width="1871" alt="image" src="https://github.com/user-attachments/assets/fc0501c8-726b-4117-85c9-a5b358ca06d9" />
</details>

Замена для [MyHomeLib](https://github.com/OleksiyPenkov/MyHomeLib)

#### Преимущества FLibrary перед MyHomeLib
* Скорость работы
  * Запуск программы
  * Создание новой коллекции
  * Построение навигации
  * Построение таблицы/дерева книг
  * Фильтрация списка книг по языку
  * Извлечение обложки/аннотации
  * Сплэшскрин не нужен :)
* Улучшеная аннотация
  * Есть оглавление, ключевые слова, эпиграф
  * Показан примерный размер текста в буквах/словах/страницах
  * Можно посмотреть все картинки книги
  * Можно извлечь картинку книги в память/файл
  * Можно открыть картинку в системном просмотрщике
  * Показываются отзывы читателей с Флибусты [^1]
* Навигация (левая панель)
  * Полный список авторов в навигации по авторам
  * Показывается информация об авторах [^1]
  * Есть навигация по архивам
  * Есть навигация по ключевым словам
  * Есть навигация языкам
  * Есть навигация по дате добавления книги в библиотеку
  * Навигацию можно фильтровать
  * Можно увидеть все книги коллекции в одном списке  [^2]
* Есть полнотекстовый поиск по названиям книг и серий, именам авторов
* Массовое (>50К) извлечение книг работает
* Автоматически определяет обновление inpx коллекции, умеет добавить новый архив в коллекцию
* Можно добавить в коллекцию неиндексированные книги или архивы с книгами
* Можно сливать коллекции в одну, просто храните их файлы в одной папке
* Поддерживаются разные форматы архивов, не только zip. См. [7z.dll](https://www.7-zip.org/)
* Есть собственная более экономичная форма хранения книг. [Репакер](#fb2cut) из zip прилагается
* Есть инструмент для зачистки коллекции от нежелательных книг: дублей, языков, жанров, с удалением файлов из архивов
* Языки интерфейса
  * Есть русский язык. И плохой английский :)
  * Можно добавить новый язык. Приглашаю к сотрудничеству, в том числе по правкам фраз, криво мною переведённым на неродные для меня языки
  * Локализованы названия жанров
  * Локализованы названия языков 
* Есть возможность смены оформления UI
  * Есть темы: windows, vista, 11, fusion
  * Есть цветовые схемы (светлая и тёмная)
  * Поддерживается загрузка внешних qss, а также [dll](https://github.com/heimdallr/QtStyles/releases) с вкомпилированными в них таблицами стилей
* Умеет в web (2 варианта интерфейса) и OPDS
* Развивается
#### Недостатки
* Windows 10 x64 минимум
* Только inpx-коллекции, никакого онлайна
* Меньшая интуитивность создания/добавления коллекций
* Нет поиска по совокупности критериев
* Нет тулбара
* Меньше настроек
* Скорее всего, нет ещё какой-то функциональности MHL, о которой я не знаю
* Отсутствует дизайн
* Есть [баги](https://github.com/heimdallr/books/issues)

[^1]: Требуются дополнительные файлы в папке с архивами
[^2]: Для большой коллекции потребуется время и память

# fb2cut

Консольное приложение для перепаковки архивов библиотеки  

#### Что делает
* Извлекает содержимое книг в формате fb2, вырезая из них картинки (содержимое узлов binary)
* Картинки складывает отдельно - папка covers для обложек, images для остальных картинок
* Ресайзит картинки, если из размеры превышают указанные максимумы
* Пережимает картинки в jpeg с указанным качеством сжатия
* Архивирует избавленные от картинок fb2 в указанный формат (7z или zip)
* Можно указать внешний архиватор (например 7z.exe) и параметры командной строки для него. ВНИМАНИЕ! Не стоит делать архивы непрерывными (solid), иначе при показе аннотации и извлечении книг гарантированы тормоза.
* Справку по ключам командной строки можно получить запуском утилиты с ключом -h
* При запуске без ключей будет предоставлен GUI

#### А зачем всё это?
Для уменьшения размера библиотеки в байтах, конечно. Особенно, если не нужны картинки. Или если нужны только обложки. Или если установить разумные ограничения размеров изображений и качество сжатиия. Но даже если оставить картинки в исходном размере, то всё равно будет ощутимый выигрыш от пережатия текстов в 7z и отдельного хранения изображений без кодирования в base64. Например, на момент разработки утилиты библиотека флибусты весит 448Г. После обработки утилитой без изменения размера картинок и умолчальном качестве сжалия в jpeg имеем: fb2 в 7z - 70Г, обложки - 41Г, остальные картинки - 176Г, итого - 287Г. Уже неплохо. С ограничением для обложек 1024px, а для остальных картинок - 480px с качеством сжатия 25: обложки - 25Г, остальные картинки - 46Г, итого - 141Г. Ещё лучше. И для совсем крохоборов, можно сделать картинки чёрно-белыми: обложки - 22Г, остальные картинки - 44Г, итого 136Г. PROFIT!

#### И что потом делать с перепакованными архивами?
Используем их с FLibrary вместо исходных. Или с любым другим каталогизатором, который поддерживает используемый формат архивации fb2, но книги будут без картинок.

#### Что за файлы в папках error?
Там fb2, которые не удалось распарсить. Кривой xml, левая кодировка и т.п. Можно попробовать как-то починить и подложить в соответствующий архив. Или подложить битые. Там же извлечённые из fb2 битые картинки, т.е. содержимое узлов binary, которое не удалось декодировать. Действительно, в файлах библиотеки много мусора, не являющегося валидными файлами изображений. Или валидными, но не являющиеся изображениями (html, xml, etc). Есть ещё вполне годные файлы в неподдерживаемом Qt формате, например riff. Их можно конвертнуть в jpeg каким-нибудь графическим редактором и подложить в соответствующий архив вручную. Или можно указать программе путь к ffmpeg.exe, который попытается декодировать или даже починить эти файлы. FFmpeg можно взять [тут](https://www.ffmpeg.org/). Но и FFmpeg не всесилен, бесповоротно битые файлы таковыми и останутся. Что с ними делать - решать вам. Если найдёте полезное им применения, сообщите мне, пожалуйста.

#### А что так долго-то?
Действительно, на моём компе обработка всей библиотеки продолжается около 11 часов. Львиную долю времени выполнения утилита тратит на архивацию текстов fb2. Увы, алгоритмы сжатия вычислительно затратны. К тому же, в сжатии алгоритмом PPMD участвуют не более 4-х потоков. Возможно, когда-нибудь я распараллелю запуск N/4 процессов внешнего архиватора (что вряд ли). Но переархивация всей библиотеки требуется лишь однократно. Если надо переработать изображения (изменить предельные размеры, подобрать качество кодирования в jpeg, etc), то можно отключить запись fb2 на диск, будет значительно быстрее.

#### Примеры запуска с параметрами командной строки
```
fb2cut.exe D:\fb2.Flibusta.Net\*.zip -o D:\repacked --max-size 480 --max-cover-size 1024 --image-quality 25 --image-grayscale -a "C:\Program Files\7-Zip\7z.exe" --ffmpeg C:\programs\ffmpeg\6.0\bin\ffmpeg.exe
```
```
fb2cut.exe --help
```

# Сборка  
### Windows  
Не запустится на винде ниже 10-ки, т.к. исползуется [Qt6](https://doc.qt.io/qt-6/windows.html)  
Собиралось только на MS Visual Studio 2022, прочие IDE не тестировались  
Используется C++20  

#### Установить и настроить conan  
[Инструкция](https://docs.conan.io/2/installation.html)  

#### Прописать в переменных окружения:  
PATH: добавить путь к conan.exe.  
PATH: добавить путь к cmake.exe, версия cmake должна поддерживать вашу версию MSVS, conan,... короче, берите cmake посвежее.  
PATH: добавить путь к git.exe, необязательно, но полезно, позволит в логах видеть хэш текущего коммита  
PATH: добавить путь к Inno Setup, если нужен инсталлятор.  
PATH: добавить путь к 7z.exe, для сборки портабельной версии.  

#### Зависимости:  
* Qt6 (6.8.3) [^3]  
* xerces-c [^3]  
* plog [^3]  
* boost [^3], header only  
* 7z.dll [^3]  
* ICU [^3] (для OPDS)  

#### Сконфигурировать:
Запустить батник solution_generate.bat. Возможно, сработают и другие способы, типа cmake-gui, или открыть в студии папку с исходниками.   

#### Собрать:
В результате конфигурирования в папке build будет создан солюшн FLibrary.sln. В нём надо собрать проект FLibrary.  

#### Ещё вариант:
Можно просто запустить батник build.bat. Если окружение настроено правильно, то в папке build/installer будет собраны инсталляторы и архив портабельной версии программы.

### Не Windows  
Увы, никак. Кое-где используется WinAPI. PR приветствуются.

[^3]: Подтянется из conan
